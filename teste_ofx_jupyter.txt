processa_ofx.py
import os
import re
import xml.etree.ElementTree as ET
import pandas as pd
import tkinter as tk
from tkinter import filedialog
from datetime import datetime

def corrigir_ofx_para_xml(caminho_ofx, caminho_xml):
    try:
        with open(caminho_ofx, 'r', encoding='latin1') as f:  # alterado para latin1
            linhas = f.readlines()
    except FileNotFoundError:
        print(f"‚ùå Arquivo n√£o encontrado: {caminho_ofx}")
        return False

    for i, ln in enumerate(linhas):
        if re.match(r'<\s*ofx\s*>', ln.strip(), re.IGNORECASE):
            linhas = linhas[i:]
            break
    else:
        print(f"‚ùå Tag <OFX> n√£o encontrada em {caminho_ofx}")
        return False

    corr = ['<?xml version="1.0" encoding="UTF-8"?>']
    padrao_simples = re.compile(r'^<(\w+)>([^<]+)$')
    pad_abertura = re.compile(r'^<(\w+)>$')
    pad_fech = re.compile(r'^</(\w+)>$')

    for l in linhas:
        ln = l.strip()
        m = padrao_simples.match(ln)
        if m:
            tag, valor = m.groups()
            corr.append(f"<{tag}>{valor.strip()}</{tag}>")
        elif pad_abertura.match(ln) or pad_fech.match(ln):
            corr.append(ln)
        else:
            corr.append(ln)

    with open(caminho_xml, 'w', encoding='utf-8') as f:
        f.write("\n".join(corr))

    try:
        ET.parse(caminho_xml)
        return True
    except ET.ParseError as e:
        print(f"üî¥ XML malformado em {caminho_ofx}: {e}")
        return False

def extrair_dataframe(caminho_xml):
    try:
        tree = ET.parse(caminho_xml)
        root = tree.getroot()
        trans = root.findall(".//STMTTRN")
        if not trans:
            print(f"‚ö†Ô∏è Sem <STMTTRN> em {os.path.basename(caminho_xml)}")
            return None

        rows = []
        for t in trans:
            item = {el.tag: el.text for el in t}
            rows.append(item)
        df = pd.DataFrame(rows)

        # Data
        if 'DTPOSTED' in df.columns:
            df['DTPOSTED'] = (
                df['DTPOSTED']
                .str.extract(r'(\d{8,14})')[0]
                .apply(lambda x: pd.to_datetime(x, format='%Y%m%d%H%M%S', errors='coerce')
                       if pd.notna(x) and len(x) > 8 else pd.to_datetime(x, format='%Y%m%d', errors='coerce'))
                .dt.strftime('%d/%m/%Y')
            )

        # Valor
        if 'TRNAMT' in df.columns:
            df['TRNAMT'] = df['TRNAMT'].str.replace(',', '.', regex=False).astype(float)
            df['CREDITO'] = df['TRNAMT'].apply(lambda x: x if x > 0 else "")
            df['DEBITO'] = df['TRNAMT'].apply(lambda x: x if x < 0 else "")
            df['TIPO'] = df['TRNAMT'].apply(lambda x: 'C' if x > 0 else ('D' if x < 0 else ''))
        else:
            df['CREDITO'] = ""
            df['DEBITO'] = ""
            df['TIPO'] = ""

        # Renomeia colunas
        df.rename(columns={
            'DTPOSTED': 'DATA',
            'TRNAMT': 'VALOR',
            'MEMO': 'HISTORICO',
            'CHECKNUM': 'DOCUMENTO'
        }, inplace=True)

        # Seleciona apenas as colunas tratadas, com TIPO logo ap√≥s VALOR
        colunas_desejadas = ['DATA', 'VALOR', 'TIPO', 'HISTORICO', 'DOCUMENTO', 'CREDITO', 'DEBITO']
        df = df[[col for col in colunas_desejadas if col in df.columns]]

        return df

    except Exception as e:
        print(f"‚ùå Erro ao extrair XML: {e}")
        return None

def processar_consolidado(diretorio):
    arquivos = [f for f in os.listdir(diretorio) if f.lower().endswith('.ofx')]
    if not arquivos:
        print("‚ö†Ô∏è Nenhum .ofx na pasta.")
        return

    caminho_saida = os.path.join(diretorio, 'consolidado_ofx.xlsx')

    # Se arquivo j√° existe, renomeia com timestamp
    if os.path.exists(caminho_saida):
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        novo_nome = os.path.join(diretorio, f'consolidado_ofx_{timestamp}.xlsx')
        os.rename(caminho_saida, novo_nome)
        print(f"‚ö†Ô∏è Arquivo existente renomeado para: {novo_nome}")

    writer = pd.ExcelWriter(caminho_saida, engine='openpyxl')
    dfs = []

    for nome in arquivos:
        print(f"‚û°Ô∏è Processando: {nome}")
        path_ofx = os.path.join(diretorio, nome)
        path_xml = os.path.join(diretorio, nome.replace('.ofx','_corrigido.xml'))
        ok = corrigir_ofx_para_xml(path_ofx, path_xml)
        if not ok: continue
        df = extrair_dataframe(path_xml)
        if df is None or df.empty: continue

        aba = os.path.splitext(nome)[0][:31]
        df.to_excel(writer, sheet_name=aba, index=False)
        df['ARQUIVO'] = aba  # para consolida√ß√£o
        dfs.append(df)

    # Aba consolidada
    if dfs:
        df_total = pd.concat(dfs, ignore_index=True)
        colunas_ordenadas = ['ARQUIVO', 'DATA', 'VALOR', 'TIPO', 'HISTORICO', 'DOCUMENTO', 'CREDITO', 'DEBITO']
        df_total = df_total[[col for col in colunas_ordenadas if col in df_total.columns]]
        df_total.to_excel(writer, sheet_name='CONSOLIDADO', index=False)

    writer.close()
    print(f"\n‚úÖ Consolidado salvo em: {caminho_saida}")

if __name__ == "__main__":
    root = tk.Tk(); root.withdraw()
    print("üìÅ Selecione a pasta de entrada com arquivos .ofx")
    pasta = filedialog.askdirectory(title="Selecione a pasta com arquivos OFX")
    if pasta:
        processar_consolidado(pasta)
    else:
        print("‚ùå Pasta n√£o selecionada; saindo.")